<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BelgeDedektif</title>
  <!-- Tailwind via CDN (hızlı prototip) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html,body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b1020;color:#e6ebff}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08);backdrop-filter: blur(8px)}
    .glass{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)}
    .btn{border-radius:16px;padding:.75rem 1rem}
    .tag{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:9999px;padding:.15rem .6rem;font-size:.75rem}
    .grid-auto{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .fade-in{animation:fade .3s ease-out}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
  <header class="max-w-6xl mx-auto px-4 sm:px-6 py-6">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-indigo-500/20 border border-indigo-400/30 grid place-items-center">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-6 h-6"><path fill="currentColor" d="M7 3h10a2 2 0 0 1 2 2v9.5l-3.5-2.333a2 2 0 0 0-2.318.083L7 17V5a2 2 0 0 1 2-2Z"/><path fill="currentColor" d="M5 5a4 4 0 0 1 4-4h6a4 4 0 0 1 4 4v14a2 2 0 0 1-3.164 1.643l-3.47-2.452a2 2 0 0 0-2.318.083L5 21V5Z" opacity=".4"/></svg>
      </div>
      <div>
        <h1 class="text-xl font-semibold">BelgeDedektif</h1>
        <p class="text-sm text-slate-300/80">Yükle → OCR → Listele. Hızlı test arayüzü.</p>
      </div>
      <div class="ml-auto flex items-center gap-2 text-sm">
        <span class="tag">API: <code id="apiBaseTag">/api</code></span>
        <button id="refreshBtn" class="btn glass hover:bg-white/10">Yenile</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 pb-16">
    <!-- Upload Card -->
    <section class="card rounded-2xl p-5 sm:p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-center gap-4">
        <div class="flex-1">
          <h2 class="text-lg font-semibold">Belge yükle</h2>
          <p class="text-sm text-slate-300/80">JPG, PNG veya PDF dosyası yükleyin. Yükleme bittikten sonra otomatik analiz edilir.</p>
        </div>
        <form id="uploadForm" class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
          <input type="file" id="fileInput" name="file" class="file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:bg-indigo-500/20 file:text-indigo-200 file:cursor-pointer file:hover:bg-indigo-500/30 text-sm" required>
          <button class="btn bg-indigo-600 hover:bg-indigo-500" type="submit">Yükle & Analiz Et</button>
        </form>
      </div>
      <div id="progressWrap" class="hidden mt-4">
        <div class="w-full bg-white/10 rounded-xl overflow-hidden">
          <div id="progressBar" class="h-2 bg-indigo-400" style="width:0%"></div>
        </div>
        <p id="progressText" class="text-xs text-slate-300/80 mt-2">Başlıyor…</p>
      </div>
      <p id="uploadMsg" class="mt-3 text-sm"></p>
    </section>

    <!-- Filters -->
    <section class="flex items-center gap-3 mb-3">
      <input id="search" placeholder="Ara: ad, firma, tarih, OCR…" class="glass rounded-xl px-4 py-2 w-full md:w-96 outline-none" />
      <select id="sortSel" class="glass rounded-xl px-3 py-2">
        <option value="dateDesc">Tarih ↓</option>
        <option value="dateAsc">Tarih ↑</option>
        <option value="nameAsc">Ad A→Z</option>
        <option value="nameDesc">Ad Z→A</option>
      </select>
    </section>

    <!-- List -->
    <section id="list" class="grid grid-auto gap-4"></section>

    <!-- Empty state -->
    <template id="emptyTpl">
      <div class="text-center text-slate-300/80 py-16">
        <p class="text-lg">Henüz belge yok.</p>
        <p class="text-sm">Yukarıdan bir dosya yükleyin.</p>
      </div>
    </template>

    <template id="cardTpl">
      <article class="card rounded-2xl p-4 fade-in">
        <div class="flex items-start gap-3">
          <img class="w-14 h-14 object-cover rounded-xl border border-white/10" alt="Önizleme" />
          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-2">
              <h3 class="font-semibold truncate"></h3>
              <span class="tag date"></span>
              <span class="tag firm"></span>
            </div>
            <a class="text-xs text-indigo-300 hover:underline break-all" target="_blank" rel="noreferrer noopener"></a>
          </div>
        </div>
        <pre class="mt-3 text-xs whitespace-pre-wrap text-slate-200/90 max-h-48 overflow-auto"></pre>
      </article>
    </template>
  </main>

  <script>
    // ==== Ayarlar ====
    const API_BASE = "/api"; // aynı domain altındaysa böyle kalsın; yoksa tam URL yaz
    document.querySelector('#apiBaseTag').textContent = API_BASE;

    // ==== Upload ====
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const progressWrap = document.getElementById('progressWrap');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const uploadMsg = document.getElementById('uploadMsg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!fileInput.files[0]) return;
      uploadMsg.textContent = '';
      progressWrap.classList.remove('hidden');
      progressBar.style.width = '10%';
      progressText.textContent = 'Yükleniyor…';

      try {
        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        const res = await fetch(`${API_BASE}/upload-and-analyze`, { method: 'POST', body: fd });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        progressBar.style.width = '70%';
        progressText.textContent = 'Analiz ediliyor…';
        const data = await res.json().catch(()=>({}));
        progressBar.style.width = '100%';
        progressText.textContent = 'Bitti';
        uploadMsg.className = 'text-green-300';
        uploadMsg.textContent = 'Yükleme başarılı.';
        fileInput.value = '';
        await loadDocs();
      } catch (err) {
        uploadMsg.className = 'text-red-300';
        uploadMsg.textContent = 'Hata: ' + err.message;
      } finally {
        setTimeout(()=>{progressWrap.classList.add('hidden');progressBar.style.width='0%';}, 800);
      }
    });

    // ==== Listeleme ====
    const listEl = document.getElementById('list');
    const cardTpl = document.getElementById('cardTpl');
    const emptyTpl = document.getElementById('emptyTpl');
    const refreshBtn = document.getElementById('refreshBtn');
    const search = document.getElementById('search');
    const sortSel = document.getElementById('sortSel');

    refreshBtn.addEventListener('click', loadDocs);
    search.addEventListener('input', render);
    sortSel.addEventListener('change', render);

    let docs = [];

    async function loadDocs(){
      try{
        const r = await fetch(`${API_BASE}/documents`);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        docs = await r.json();
        render();
      }catch(e){
        listEl.innerHTML = `<p class='text-red-300'>Liste alınamadı: ${e.message}</p>`;
      }
    }

    function render(){
      const q = search.value.trim().toLowerCase();
      let rows = docs.slice();
      // filtre
      if(q){
        rows = rows.filter(x => [x.Ad, x.Firma, x.Tarih, x.OCR].join(' ').toLowerCase().includes(q));
      }
      // sıralama
      switch(sortSel.value){
        case 'dateAsc': rows.sort((a,b)=> (a.Tarih||'').localeCompare(b.Tarih||'')); break;
        case 'nameAsc': rows.sort((a,b)=> (a.Ad||'').localeCompare(b.Ad||'')); break;
        case 'nameDesc': rows.sort((a,b)=> (b.Ad||'').localeCompare(a.Ad||'')); break;
        default: rows.sort((a,b)=> (b.Tarih||'').localeCompare(a.Tarih||''));
      }

      listEl.innerHTML = '';
      if(rows.length === 0){
        listEl.appendChild(document.importNode(emptyTpl.content,true));
        return;
      }

      for(const d of rows){
        const node = document.importNode(cardTpl.content,true);
        const img = node.querySelector('img');
        const title = node.querySelector('h3');
        const link = node.querySelector('a');
        const date = node.querySelector('.date');
        const firm = node.querySelector('.firm');
        const pre = node.querySelector('pre');

        title.textContent = d.Ad || 'Belge';
        date.textContent = d.Tarih || 'Tarih yok';
        firm.textContent = d.Firma || 'Firma yok';
        link.textContent = d.BlobURL || '';
        if (d.BlobURL) link.href = d.BlobURL;
        pre.textContent = (d.OCR || '').trim() || '—';
        if(d.BlobURL && /\.(png|jpg|jpeg|webp|gif)$/i.test(d.BlobURL)){
          img.src = d.BlobURL;
        } else {
          img.src = 'https://dummyimage.com/128x128/1f2937/ffffff&text=PDF';
        }
        listEl.appendChild(node);
      }
    }

    // Başlangıç yükü
    loadDocs();
  </script>
</body>
</html>
