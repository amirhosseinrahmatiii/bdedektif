<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Belge Dedektif</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f4f7fb; }
        .invoice-card { transition: box-shadow 0.2s; }
        .invoice-card:hover { box-shadow: 0 4px 20px #0001; }
        .preview-img { max-height: 100px; border-radius: 8px; }
        .table-responsive { max-height: 350px; }
    </style>
</head>
<body>
    <div class="container py-4">
        <h2 class="mb-4 fw-bold text-primary">ðŸ“„ BelgeDedektif'e HoÅŸgeldiniz!</h2>

        <!-- Dosya YÃ¼kleme Formu -->
        <form id="uploadForm" class="mb-3" enctype="multipart/form-data">
            <div class="input-group">
                <input class="form-control" type="file" name="files" id="fileInput" multiple accept=".pdf,.docx,.txt,.jpg,.jpeg,.png">
                <button class="btn btn-success" type="submit">YÃ¼kle & Analiz Et</button>
            </div>
            <div id="uploadStatus" class="form-text text-success mt-1"></div>
        </form>

        <!-- Ã–zet Kartlar -->
        <div class="row mb-4" id="summaryRow" style="display:none;">
            <div class="col-md-3 mb-2">
                <div class="card shadow-sm text-center">
                    <div class="card-body">
                        <div class="fs-2 fw-bold text-info" id="totalSum">â‚º0</div>
                        <div class="text-muted">Toplam FiÅŸ/Fatura TutarÄ±</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-2">
                <div class="card shadow-sm text-center">
                    <div class="card-body">
                        <div class="fs-3 fw-bold text-warning" id="totalVat">â‚º0</div>
                        <div class="text-muted">Toplam KDV</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-2">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="fw-bold mb-1">En Ã‡ok FiÅŸ Kesilen Firmalar:</div>
                        <div id="topVendors"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Son YÃ¼klenen Belgeler Tablosu -->
        <div class="table-responsive">
            <table class="table table-hover align-middle bg-white rounded shadow-sm" id="recordsTable">
                <thead class="table-primary">
                    <tr>
                        <th>Ã–nizleme</th>
                        <th>Dosya</th>
                        <th>Tarih</th>
                        <th>KDV</th>
                        <th>Toplam</th>
                        <th>Firma</th>
                        <th>Ä°ÅŸlem</th>
                    </tr>
                </thead>
                <tbody id="recordsTbody">
                    <!-- JS ile dolacak -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal: Soru Sor -->
    <div class="modal fade" id="askModal" tabindex="-1" aria-labelledby="askModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" id="askForm">
          <div class="modal-header">
            <h5 class="modal-title" id="askModalLabel">Sorunuzu YazÄ±n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="filename" id="askFilename">
            <div class="mb-2">
                <textarea class="form-control" name="question" id="askQuestion" rows="3" placeholder="FiÅŸ, KDV, toplam, satÄ±cÄ± vb. sorularÄ±nÄ±zÄ± yazÄ±n..."></textarea>
            </div>
            <div id="askResult" class="alert alert-info d-none"></div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Sor</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Bootstrap JS + Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Helper: API endpoint
    const API = location.origin;

    // YÃ¼kleme Formu
    document.getElementById('uploadForm').onsubmit = async (e) => {
        e.preventDefault();
        const files = document.getElementById('fileInput').files;
        if (!files.length) return;
        const formData = new FormData();
        for (let f of files) formData.append('files', f);
        let res = await fetch(API + "/upload-analyze", { method: "POST", body: formData });
        if (res.ok) {
            document.getElementById('uploadStatus').innerText = "YÃ¼kleme ve analiz baÅŸarÄ±lÄ±!";
            loadSummary();
            loadRecords();
        }
        else document.getElementById('uploadStatus').innerText = "YÃ¼kleme baÅŸarÄ±sÄ±z.";
    };

    // Son YÃ¼klenen Belgeler Tablosunu Doldur
    async function loadRecords() {
        let tbody = document.getElementById('recordsTbody');
        tbody.innerHTML = '';
        let res = await fetch(API + "/records");
        if (!res.ok) return;
        let data = await res.json();
        for (let doc of data.records) {
            let tr = document.createElement('tr');
            let imgPreview = doc.file_name.match(/\.(jpg|jpeg|png)$/i) ? 
                `<img src="${doc.blob_url}" class="preview-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/337/337940.png';">` : 
                `<span class="text-muted small">--</span>`;
            tr.innerHTML = `
                <td>${imgPreview}</td>
                <td>${doc.file_name}</td>
                <td>${doc.uploaded_at || '-'}</td>
                <td>${doc.vat_amount ? 'â‚º'+doc.vat_amount.toFixed(2) : '-'}</td>
                <td>${doc.total_amount ? 'â‚º'+doc.total_amount.toFixed(2) : '-'}</td>
                <td>${doc.vendor_name || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="showAskModal('${doc.file_name}')">Sor</button>
                    <a href="${doc.blob_url}" class="btn btn-sm btn-outline-success" target="_blank">Ä°ndir</a>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord(${doc.id})">Sil</button>
                </td>
            `;
            tbody.appendChild(tr);
        }
    }

    // KÄ±sayol: Sor ModalÄ±
    function showAskModal(filename) {
        document.getElementById('askFilename').value = filename;
        document.getElementById('askQuestion').value = '';
        document.getElementById('askResult').classList.add('d-none');
        new bootstrap.Modal(document.getElementById('askModal')).show();
    }

    // Soru Sor Submit
    document.getElementById('askForm').onsubmit = async (e) => {
        e.preventDefault();
        let filename = document.getElementById('askFilename').value;
        let question = document.getElementById('askQuestion').value;
        if (!question.trim()) return;
        let res = await fetch(API + "/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ filename, question })
        });
        let data = await res.json();
        let box = document.getElementById('askResult');
        box.classList.remove('d-none');
        box.innerText = data.answer || data.error || "YanÄ±t alÄ±namadÄ±";
    };

    // Silme
    async function deleteRecord(id) {
        if (!confirm("Silmek istediÄŸinize emin misiniz?")) return;
        let res = await fetch(API + "/delete?id=" + id, { method: "DELETE" });
        if (res.ok) loadRecords();
    }

    // Ã–zet Kartlar
    async function loadSummary() {
        let res = await fetch(API + "/summary");
        if (!res.ok) return;
        let data = await res.json();
        document.getElementById('summaryRow').style.display = '';
        document.getElementById('totalSum').innerText = "â‚º" + (data.total_sum_month || 0).toLocaleString('tr-TR');
        document.getElementById('totalVat').innerText = "â‚º" + (data.total_vat_month || 0).toLocaleString('tr-TR');
        let vendors = (data.top_vendors_month || []).map(x => `<span class="badge bg-secondary mx-1">${x.vendor} (${x.count})</span>`).join('');
        document.getElementById('topVendors').innerHTML = vendors || '<span class="text-muted">Yok</span>';
    }

    // Sayfa YÃ¼klenince
    window.onload = () => {
        loadSummary();
        loadRecords();
    }
    </script>
</body>
</html>
