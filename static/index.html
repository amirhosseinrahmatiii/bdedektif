<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Belge Dedektif – Fatura/Fiş Analiz Platformu</title>
  <style>
    body { font-family: Arial; background: #f7fafd; }
    h1 { color: #1e63d1; }
    #belgeler { width: 95%; margin: 20px auto; border-collapse: collapse; }
    #belgeler th, #belgeler td { border: 1px solid #aaa; padding: 5px; }
    #belgeler th { background: #e7effb; }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>Belge Dedektif – Fatura/Fiş Analiz Platformu</h1>
  <input type="file" id="dosya"><button onclick="yukle()">Yükle & Analiz Et</button>
  <span id="mesaj"></span>
  <hr>
  <b>Yüklenen Belgeler</b>
  <table id="belgeler">
    <tr>
      <th>Ad</th><th>Tarih</th><th>Firma</th><th>KDV</th><th>Toplam</th><th>Al Soru</th>
    </tr>
    <tbody id="tablo"></tbody>
  </table>
  <script>
    function tabloyuGuncelle() {
      fetch("/records").then(r => r.json()).then(data => {
        let t = '';
        data.records.forEach(d => {
          t += `<tr>
            <td><a href="${d.blob_url}" target="_blank">${d.ad}</a></td>
            <td>${d.tarih||''}</td>
            <td>${d.firma||''}</td>
            <td>${d.kdv||''}</td>
            <td>${d.toplam||''}</td>
            <td>
              <input placeholder="Sor..." id="q${d.ad.replace(/[^a-zA-Z0-9]/g,'')}" style="width:110px">
              <button onclick="sor('${d.ad}')">Sor</button>
              <div id="a${d.ad.replace(/[^a-zA-Z0-9]/g,'')}"></div>
            </td>
          </tr>`;
        });
        document.getElementById("tablo").innerHTML = t;
      });
    }
    function yukle() {
      var f = document.getElementById("dosya").files[0];
      if (!f) return alert("Dosya seç!");
      var fd = new FormData();
      fd.append("file", f);
      fetch("/upload-analyze", {method: "POST", body: fd})
        .then(r=>r.json()).then(res => {
          if (res.filename) {
            document.getElementById("mesaj").innerHTML = "<span class='success'>Başarılı!</span>";
            tabloyuGuncelle();
          } else {
            document.getElementById("mesaj").innerHTML = "<span class='error'>Hata: "+(res.detail||"")+"</span>";
          }
        });
    }
    function sor(ad) {
      var qid = "q"+ad.replace(/[^a-zA-Z0-9]/g,'');
      var aid = "a"+ad.replace(/[^a-zA-Z0-9]/g,'');
      var soru = document.getElementById(qid).value;
      var fd = new FormData();
      fd.append("filename", ad);
      fd.append("question", soru);
      fetch("/ai-ask", {method:"POST", body:fd})
        .then(r=>r.json()).then(res => {
          document.getElementById(aid).innerText = res.answer;
        });
    }
    tabloyuGuncelle();
    setInterval(tabloyuGuncelle, 10000);
  </script>
</body>
</html>
