<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Belge Dedektif – Fatura/Fiş Analiz Platformu</title>
    <style>
        body { font-family: Arial; margin: 2rem; background: #f5f7fa; }
        h2 { color: #2a71d0 }
        table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
        th, td { border: 1px solid #b6b6b6; padding: 7px; text-align: left; }
        th { background: #d7e8fa; }
        .success { color: green; }
        .fail { color: red; }
    </style>
</head>
<body>
    <h2>Belge Dedektif – Fatura/Fiş Analiz Platformu</h2>
    <input type="file" id="fileInput">
    <button onclick="uploadFile()">Yükle & Analiz Et</button>
    <p id="status"></p>
    <hr>
    <h3>Yüklenen Belgeler</h3>
    <table>
        <thead>
            <tr>
                <th>Ad</th>
                <th>Tarih</th>
                <th>Firma</th>
                <th>KDV</th>
                <th>Toplam</th>
                <th>OCR</th>
                <th>İndir</th>
            </tr>
        </thead>
        <tbody id="recordsTable"></tbody>
    </table>
<script>
async function uploadFile() {
    let fileInput = document.getElementById('fileInput');
    if (!fileInput.files.length) return alert("Dosya seçin!");
    let file = fileInput.files[0];
    let formData = new FormData();
    formData.append("file", file);

    document.getElementById('status').innerText = "Yükleniyor...";
    let res = await fetch('/upload-analyze', { method: 'POST', body: formData });
    let data = await res.json();
    if (data.success) {
        document.getElementById('status').innerHTML = `<span class="success">Başarılı! OCR: <br>${data.ocr.slice(0,250)}...</span>`;
        loadRecords();
    } else {
        document.getElementById('status').innerHTML = `<span class="fail">Hata: ${data.error}</span>`;
    }
}

async function loadRecords() {
    let res = await fetch('/records');
    let data = await res.json();
    let html = "";
    data.records.forEach(r => {
        html += `<tr>
            <td>${r.Ad}</td>
            <td>${r.Tarih}</td>
            <td>${r.Firma}</td>
            <td>${r.KDV}</td>
            <td>${r.Toplam}</td>
            <td>${r.OCR.slice(0, 80)}...</td>
            <td><a href="${r.BlobURL}" target="_blank">İndir</a></td>
        </tr>`;
    });
    document.getElementById('recordsTable').innerHTML = html;
}
window.onload = loadRecords;
</script>
</body>
</html>
