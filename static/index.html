<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Belge Dedektif | Fatura/Fiş Analiz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container my-5">
    <h2>Belge Dedektif – Fatura/Fiş Analiz Platformu</h2>
    <form id="uploadForm" class="my-4">
        <div class="mb-3">
            <input type="file" class="form-control" id="fileInput" required>
        </div>
        <button type="submit" class="btn btn-primary">Yükle &amp; Analiz Et</button>
    </form>
    <div id="result" class="my-3"></div>
    <h4 class="mt-4">Yüklenen Belgeler</h4>
    <table class="table" id="recordTable"><thead>
        <tr><th>Ad</th><th>Tarih</th><th>Firma</th><th>KDV</th><th>Toplam</th><th>AI Soru</th></tr>
    </thead><tbody></tbody></table>
</div>
<script>
document.getElementById("uploadForm").onsubmit = async function(e){
    e.preventDefault();
    let file = document.getElementById("fileInput").files[0];
    if(!file) return alert("Dosya seçiniz.");
    let form = new FormData();
    form.append("file", file);
    let r = await fetch("/upload-analyze", {method: "POST", body: form});
    let res = await r.json();
    document.getElementById("result").innerHTML = "<b>" + res.message + "</b><br>" + (res.extracted_text||"");
    loadRecords();
};

async function loadRecords(){
    let t = document.querySelector("#recordTable tbody");
    t.innerHTML = "";
    let r = await fetch("/records");
    let js = await r.json();
    for(let row of js.records){
        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.filename}</td>
            <td>${row.uploaded_at.split("T")[0]}</td>
            <td>${row.vendor_name||""}</td>
            <td>${row.vat_amount||""}</td>
            <td>${row.total_amount||""}</td>
            <td>
                <input class="form-control form-control-sm mb-1" type="text" placeholder="Bir soru yaz" id="q_${row.id}">
                <button class="btn btn-outline-secondary btn-sm" onclick="askAI(${row.id})">Sor</button>
                <div id="a_${row.id}" class="small mt-1"></div>
            </td>`;
        t.appendChild(tr);
    }
}
window.onload = loadRecords;

async function askAI(id){
    let q = document.getElementById("q_"+id).value;
    if(!q) return;
    let form = new FormData();
    form.append("id", id);
    form.append("question", q);
    let r = await fetch("/ask", {method:"POST", body:form});
    let js = await r.json();
    document.getElementById("a_"+id).innerText = js.answer;
}
</script>
</body>
</html>
