<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Belge Dedektif</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f4f7fb; }
        .container { margin-top: 30px; }
        .card { border-radius: 12px; box-shadow: 0 2px 8px #e1e1e1; }
        .preview-img { max-height: 120px; border-radius: 8px; }
        .table-responsive { max-height: 350px; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="mb-4 fw-bold text-primary">BelgeDedektif’e Hoşgeldiniz!</h2>
        <!-- Dosya Yükleme Formu -->
        <form id="uploadForm" enctype="multipart/form-data" class="mb-4">
            <div class="input-group mb-2">
                <input class="form-control" type="file" name="files" id="fileInput" multiple accept=".pdf,.docx,.txt,.jpg,.jpeg,.png">
                <button class="btn btn-success" type="submit">Yükle & Analiz Et</button>
            </div>
            <div id="uploadStatus" class="form-text text-success mt-1"></div>
        </form>
        <!-- Son Yüklenen Belgeler Tablosu -->
        <div class="card">
            <div class="card-header bg-light">
                <b>Son Yüklenen Belgeler</b>
            </div>
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead class="table-primary">
                        <tr>
                            <th>Dosya</th>
                            <th>Tarih</th>
                            <th>KDV</th>
                            <th>Toplam</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTable"></tbody>
                </table>
            </div>
        </div>
    </div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const uploadForm = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const uploadStatus = document.getElementById('uploadStatus');
    const recordsTable = document.getElementById('recordsTable');

    // Dosya yükleme işlemi
    uploadForm.onsubmit = async function (e) {
        e.preventDefault();
        const formData = new FormData();
        for (const file of fileInput.files) formData.append("files", file);
        uploadStatus.textContent = "Yükleniyor...";
        let resp = await fetch("/upload-analyze", { method: "POST", body: formData });
        let data = await resp.json();
        uploadStatus.textContent = data.message || "Yükleme tamamlandı!";
        loadRecords();
    };

    // Kayıtları çek ve tabloyu doldur
    async function loadRecords() {
        let resp = await fetch("/records");
        let data = await resp.json();
        recordsTable.innerHTML = "";
        (data.records || []).forEach(r => {
            recordsTable.innerHTML += `
                <tr>
                    <td>${r.file_name}</td>
                    <td>${r.uploaded_at || ''}</td>
                    <td>${r.vat_amount}</td>
                    <td>${r.total_amount}</td>
                    <td>
                        <a href="${r.blob_url || '#'}" target="_blank">İndir</a>
                    </td>
                </tr>
            `;
        });
    }
    loadRecords();
});
</script>
</body>
</html>
